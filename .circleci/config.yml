version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable  # Executor
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - SHA256:7pNFQEQEcmBCtf7scKhJJt3L9ELoL4VrXyOziI3GqK0
      # Step 1: Extract EC2 IP from inventory.ini
      - run:
          name: Extract EC2 IP
          command: |
            EC2_IP=$(awk '/^[0-9]/{print $1; exit}' ansible/inventory.ini)
            echo "$EC2_IP" > ec2_ip.txt
  

      # Step 2: Deploy static app safely
      - run:
          name: Deploy Web App Container
          command: |
            EC2_IP=$(cat ec2_ip.txt)
            echo "Deploying to EC2: $EC2_IP"

            # Ensure app folder exists
            ssh -o StrictHostKeyChecking=no ubuntu@$EC2_IP "mkdir -p ~/web-app"

            # Copy app files
            scp -r web-app/* ubuntu@$EC2_IP:~/web-app/

            # Stop and remove old container if exists
            ssh ubuntu@$EC2_IP "docker rm -f web-app-static-site || true"

            # Backup existing image if any
            ssh ubuntu@$EC2_IP "docker images | grep web-app-static-site_backup || docker tag web-app-static-site:latest web-app-static-site_backup || true"

            # Attempt to build new image
            ssh ubuntu@$EC2_IP "cd ~/web-app && docker build -t web-app-static-site:latest . || echo BUILD_FAILED > /tmp/build_status"

            # Rollback if build failed
            ssh ubuntu@$EC2_IP "
              if [ -f /tmp/build_status ]; then
                echo 'clBuild failed â€” rolling back...'
                docker run -d -p 8080:80 --name web-app-static-site_rollback web-app-static-site_backup
                rm /tmp/build_status
                exit 1
              fi
            "

            # Run new container
            ssh ubuntu@$EC2_IP "docker run -d -p 80:80 --name web-app-static-site web-app-static-site:latest"

            # Update backup tag
            ssh ubuntu@$EC2_IP "docker tag web-app-static-site:latest web-app-static-site_backup"

workflows:
  deploy_on_push:
    jobs:
      - deploy:
          filters:
            branches:
              only:
                - main
