version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable  # Executor
    steps:
      - checkout

      # Add SSH keys stored in CircleCI project
      - add_ssh_keys:
          fingerprints:
            - SHA256:7pNFQEQEcmBCtf7scKhJJt3L9ELoL4VrXyOziI3GqK0

      # Step 1: Extract EC2 IP from inventory.ini
      
      - run:
          name: Extract EC2 IP
          command: |
            EC2_IP=$(ansible server_instance -i ansible/inventory.ini --list-hosts | awk 'NR>1 {print $1; exit}')
            # Save to file
            echo "$EC2_IP" > ec2_ip.txt

  
      # Step 2: Deploy Web App Container
      - run:
          name: Deploy Web App Container
          command: |
            EC2_IP=$(cat ec2_ip.txt)
            echo "Deploying to EC2: $EC2_IP"

            # Ensure app folder exists
            ssh -o StrictHostKeyChecking=no ubuntu@$EC2_IP "mkdir -p ~/web-app"

            # Copy web-app folder from CircleCI to EC2
            scp -r web-app/* ubuntu@$EC2_IP:~/web-app/

            # Stop and remove existing container if running
            ssh ubuntu@$EC2_IP "
              if [ \$(docker ps -q -f name=web-app-static-site) ]; then
                echo 'Stopping existing container...'
                docker rm -f web-app-static-site
              fi
            "

            # Backup existing image if any
            ssh ubuntu@$EC2_IP "
              docker images | grep web-app-static-site_backup || \
              docker tag web-app-static-site:latest web-app-static-site_backup || true
            "

            # Build new Docker image
            ssh ubuntu@$EC2_IP "
              cd ~/web-app
              docker build -t web-app-static-site:latest . || echo BUILD_FAILED > /tmp/build_status
            "

            # Rollback if build failed
            ssh ubuntu@$EC2_IP "
              if [ -f /tmp/build_status ]; then
                echo 'Build failed â€” rolling back...'
                docker run -d -p 8080:80 --name web-app-static-site_rollback web-app-static-site_backup
                rm /tmp/build_status
                exit 1
              fi
            "

            # Run new container
            ssh ubuntu@$EC2_IP "
              docker run -d -p 443:80 --name web-app-static-site web-app-static-site:latest
            "

            # Update backup tag
            ssh ubuntu@$EC2_IP "
              docker tag web-app-static-site:latest web-app-static-site_backup
            "

workflows:
  deploy_on_push:
    jobs:
      - deploy:
          filters:
            branches:
              only:
                - main
