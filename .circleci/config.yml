version: 2.1

jobs:
  deploy:
    docker:
      - image: hashicorp/terraform:latest  # Terraform executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      # Add SSH keys stored in CircleCI project
      - add_ssh_keys:
          fingerprints:
            - SHA256:7pNFQEQEcmBCtf7scKhJJt3L9ELoL4VrXyOziI3GqK0


      #Terraform init, plan and apply
      - run:
          name: Terraform plan and apply
          command: |
            cd terraform/
            terraform init
            terraform plan -out=tfplan && terraform apply -auto-approve  tfplan 
      #To Save the Previous state of the terraform apply output
      - persist_to_workspace:
          root: ~/project
          paths:
            - terraform/terraform.tfstate
            - terraform/.terraform

      # Extract EC2 IP from terraform output
      
      - run:
          name: Extract EC2 IP
          command: |
            cd terraform          
            _instance_ip=$(terraform output -raw web_instance_elastic_ip)
            instance_ip=$(echo "$instance_ip" | tr -d '"')
           
            # # Save to file
            # echo "$instance_ip" > ec2_ip.txt


  
      #  Deploy Web  Container
      - run:
          name: Deploy Web  Container
          command: |
            instance_ip=$(cat ec2_ip.txt)
            echo "Obtained IP: $instance_ip " 
    
            # Ensure app folder exists
            ssh -o StrictHostKeyChecking=no ubuntu@$instance_ip "mkdir -p ~/web-app"

            # Copy web-app folder from CircleCI to EC2
            scp -r web-app/* ubuntu@$instance_ip:~/web-app/

            # Stop and remove existing container if running
            ssh ubuntu@$instance_ip "
              if [ \$(docker ps -q -f name=web-app-static-site) ]; then
                echo 'Stopping existing container...'
                docker rm -f web-app-static-site
              fi
            "

            # Backup existing image if any
            ssh ubuntu@$instance_ip "
              docker images | grep web-app-static-site_backup || \
              docker tag web-app-static-site:latest web-app-static-site_backup || true
            "

            # Build new Docker image
            ssh ubuntu@$instance_ip "
              cd ~/web-app
              docker build -t web-app-static-site:latest . || echo BUILD_FAILED > /tmp/build_status
            "

            # Rollback if build failed
            ssh ubuntu@$instance_ip "
              if [ -f /tmp/build_status ]; then
                echo 'Build failed â€” rolling back...'
                docker run -d -p 8080:80 --name web-app-static-site_rollback web-app-static-site_backup
                rm /tmp/build_status
                exit 1
              fi
            "

            # Run new container
            ssh ubuntu@$instance_ip "
              docker run -d -p 443:80 --name web-app-static-site web-app-static-site:latest
            "

            # Update backup tag
            ssh ubuntu@$instance_ip "
              docker tag web-app-static-site:latest web-app-static-site_backup
            "

workflows:
  deploy_on_push:
    jobs:
      - deploy:
          filters:
            branches:
              only:
                - main
