version: 2.1

jobs:
  terraform:
    docker:
      - image: hashicorp/terraform:latest  # Terraform executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      # Add SSH keys stored in CircleCI project
      - add_ssh_keys:
          fingerprints:
            - SHA256:7pNFQEQEcmBCtf7scKhJJt3L9ELoL4VrXyOziI3GqK0


      #Terraform init, plan and apply
      - run:
          name: Terraform plan and apply
          command: |
            cd terraform/
            terraform init
            terraform plan -out=tfplan && terraform apply -auto-approve  tfplan 
      #To Save the Previous state of the terraform apply output
      - persist_to_workspace:
          root: ~/project
          paths:
            - terraform/terraform.tfstate
            - terraform/.terraform
            - ansible/inventory.ini

      - run:
          name: Debug - List files
          command: |
           ls -la ~/
      #
          # attach_workspace:
          # at: ~/project
  ansible:
    docker:
     - image: cimg/base:stable
    steps:
     - checkout
     - setup_remote_docker
     - attach_workspace:
        at: ~/project     
     - run:
         name: Install Ansible
         command: sudo apt-get update &&  sudo apt-get install -y ansible
    
    # Verify inventory exists
     - run:
          name: Check Inventory
          command: cat ~/project/ansible/inventory.ini
     - run:
         name: Fix SSH Key Path for CircleCI
         command: |
           sed -i 's|/home/precious/ssh-keys/ec2-instance-key.pem|/home/circleci/project/ssh-keys/ec2-instance-key.pem|' ~/project/ansible/inventory.ini

     
     - run:
         name: Run Ansible Playbook
         command: |
           ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ~/project/ansible/inventory.ini ansible/playbook.yml 

workflows:
  deploy_on_push:
    jobs:
      - terraform
      - ansible:
          requires:
            - terraform
filters:
branches:
      only:
        - main



  
     

            